(function(f,O){typeof exports=="object"&&typeof module<"u"?module.exports=O(require("axios"),require("lodash"),require("mobx"),require("uuid"),require("crypto-js")):typeof define=="function"&&define.amd?define(["axios","lodash","mobx","uuid","crypto-js"],O):(f=typeof globalThis<"u"?globalThis:f||self,f["arm-js-library"]=O(f.axios,f._,f.mobx,f.uuid,f.CryptoJS))})(this,function(f,O,es,N,ts){"use strict";function is(R){const s=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(R){for(const e in R)if(e!=="default"){const t=Object.getOwnPropertyDescriptor(R,e);Object.defineProperty(s,e,t.get?t:{enumerable:!0,get:()=>R[e]})}}return s.default=R,Object.freeze(s)}const rs=is(es),{makeObservable:os,observable:F,action:E,toJS:D}=rs,{get:o,set:h,find:y,findIndex:g,isObject:as,isArray:q,isPlainObject:I,isNumber:v,isNull:J,isNil:b,isEmpty:P,isEqual:p,gte:m,gt:ns,lte:hs,lt:$,flatMap:cs,map:U,entries:ds,forEach:u,keysIn:A,omit:C}=O,V={isLoading:!0,isError:!1,isNew:!0,data:[],included:[],meta:{}},z={isLoading:!0,isError:!1,isNew:!0,data:{},included:[],meta:{}},L=["destroyRecord","getCollection","reload","save","set","get","setProperties","isDirty","isError","isLoading","isPristine"],us=["destroyRecord","getCollection","reload","save","set","get","setProperties","isDirty","isError","isLoading","isPristine","hashId","collectionName"];class ls{constructor(s=[]){this.namespace="api/v1",this.host=typeof window<"u"?window.location.origin:"",this.collections={},this.aliases={},this.requestHashIds={},this.payloadIncludedReference="type",this._initializeCollections(s),this._initializeAxiosConfig(),os(this,{collections:F,aliases:F,requestHashIds:F,_pushPayload:E,_pushRequestHash:E,_addCollection:E,_addAlias:E})}_initializeAxiosConfig(){f.defaults.baseURL=this._getBaseURL()}_initializeCollections(s){u(s,e=>this._addCollection(e,[]))}_getBaseURL(){return`${this.host}/${this.namespace}`}_getAuthorizationToken(){return`Token ${window.localStorage.getItem("token")}`}_isCollectionExisting(s){if(b(o(this.collections,s)))throw`Collection ${s} does not exist.
Fix: Try adding ${s} on your ARM config initialization.`}_addCollection(s,e){this.collections[s]=e}_addAlias(s,e){const t=q(e),r=I(e);t&&(this.aliases[s]=e||[]),r&&(this.aliases[s]=e||{})}_generateHashId(s={id:N.v1()}){const e=JSON.stringify(s);return ts.MD5(e).toString()}_getProperty(s){return o(this,s)}_setProperty(s,e){h(this,s,e);const t=C(D(this.originalRecord),L),r=C(D(this),L);p(t,r)?(h(this,"isDirty",!1),h(this,"isPristine",!0)):(h(this,"isDirty",!0),h(this,"isPristine",!1))}_setProperties(s){function e(a,n=""){return cs(ds(a),([d,c])=>{const _=n?`${n}.${d}`:d;return as(c)&&!q(c)&&c!==null?e(c,_):{key:_,value:c}})}const t=e(s);u(t,({key:a,value:n})=>h(this,a,n));const r=C(D(this.originalRecord),L),i=C(D(this),L);p(r,i)?(h(this,"isDirty",!1),h(this,"isPristine",!0)):(h(this,"isDirty",!0),h(this,"isPristine",!1))}_unloadFromCollection(s){const e=o(s,"collectionName"),t=g(this.collections[e],{hashId:o(s,"hashId")});m(t,0)&&this.collections[e].splice(t,1)}_unloadFromRequestHashes(s){const e=A(this.requestHashIds);u(e,t=>{const r=o(this.requestHashIds[t],"data"),i=q(r),a=I(r);if(i){const n=g(o(this.requestHashIds[t],"data"),{hashId:o(s,"hashId")});m(n,0)&&this.requestHashIds[t].data.splice(n,1)}a&&p(o(s,"hashId"),o(this.requestHashIds[t],"data.hashId"))&&h(this.requestHashIds[t],"data",{})})}_unloadFromAliases(s){const e=A(this.aliases);u(e,t=>{const r=q(this.aliases[t]),i=I(this.aliases[t]);if(r){const a=g(this.aliases[t],{hashId:o(s,"hashId")});m(a,0)&&this.aliases[t].splice(a,1)}i&&p(o(s,"hashId"),o(this.aliases[t],"hashId"))&&(this.aliases[t]={})})}unloadRecord(s){this._unloadFromCollection(s),this._unloadFromRequestHashes(s),this._unloadFromAliases(s)}_saveRecord(s){const e=o(s,"collectionName"),t=y(this.collections[e],{hashId:o(s,"hashId")}),r=v(o(t,"id")),i=r?o(t,"id"):null,c={resourceMethod:r?"put":"post",resourceName:e,resourceId:i,resourceParams:{},resourcePayload:{data:t},resourceFallback:{},resourceConfig:{}};return this._request(c)}async _deleteRecord(s){const e=o(s,"collectionName"),t=y(this.collections[e],{hashId:o(s,"hashId")}),r=o(s,"id"),n={resourceMethod:"delete",resourceName:o(t,"collectionName"),resourceId:Number(r),resourceParams:{},resourcePayload:null,resourceFallback:{},resourceConfig:{}};return this._request(n)}async _reloadRecord(s){const e=o(s,"id"),i={resourceMethod:"get",resourceName:o(s,"collectionName"),resourceId:Number(e),resourceParams:{},resourcePayload:null,resourceFallback:{},resourceConfig:{skipId:N.v1()}};return this._request(i)}_getCollectionRecord(s,e={},t){const r=o(e,"referenceKey")||"",i=o(e,"async")||!1,a=o(t,r)||[],d=I(a)?[a]:a,c=F([]);return u(d,_=>{const j=this._generateHashId({id:o(_,"id"),collectionName:s}),M=y(this.collections[s],{hashId:j});if(!P(M))c.push(M);else if(i){const T={resourceMethod:"get",resourceName:s,resourceId:o(_,"id"),resourceParams:{},resourcePayload:null,resourceFallback:{},resourceConfig:{}},S=z;this._pushRequestHash(T,S),this._request(T)}}),c}_injectActions(s){const e={get:this._getProperty,set:this._setProperty,setProperties:this._setProperties,save:()=>this._saveRecord(s),destroyRecord:()=>this._deleteRecord(s),reload:()=>this._reloadRecord(s),getCollection:(r,i)=>this._getCollectionRecord(r,i,s)},t=A(e);u(t,r=>{s[r]=e[r]})}_injectReferenceKeys(s,e,t=null){const r=J(t)?this._generateHashId({id:o(e,"id"),collectionName:s}):t;h(e,"collectionName",s),h(e,"hashId",r),h(e,"isLoading",!1),h(e,"isError",!1),h(e,"isPristine",!0),h(e,"isDirty",!1)}_pushToCollection(s,e){const t=q(e),r=I(e);if(t){const i=U(e,"hashId");return u(e,a=>{const n=g(this.collections[s],{hashId:o(a,"hashId")});this._injectActions(a),$(n,0)&&this.collections[s].push(a),m(n,0)&&(this.collections[s][n]=a)}),U(i,a=>y(this.collections[s],{hashId:a}))}if(r){const i=e.hashId,a=g(this.collections[s],{hashId:o(e,"hashId")});return this._injectActions(e),$(a,0)&&this.collections[s].push(e),m(a,0)&&(this.collections[s][a]=e),y(this.collections[s],{hashId:i})}}_pushToAliases(s){const e=q(s),t=I(s),r=A(this.aliases);e&&u(r,i=>{const a=q(this.aliases[i]),n=I(this.aliases[i]);a&&u(s,d=>{const c=g(this.aliases[i],{hashId:o(d,"hashId")});m(c,0)&&(this.aliases[i][c]=d)}),n&&u(s,d=>{p(o(d,"hashId"),o(this.aliases[i],"hashId"))&&(this.aliases[i]=d)})}),t&&u(r,i=>{const a=q(this.aliases[i]),n=I(this.aliases[i]);a&&u([s],d=>{const c=g(this.aliases[i],{hashId:o(d,"hashId")});m(c,0)&&(this.aliases[i][c]=d)}),n&&p(o(s,"hashId"),o(this.aliases[i],"hashId"))&&(this.aliases[i]=s)})}_pushToRequestHashes(s){const e=A(this.requestHashIds),t=q(s),r=I(s);let i=null;t&&(i=s),r&&(i=[s]),u(e,a=>{const n=o(this.requestHashIds[a],"data"),d=q(n),c=I(n);u(i,_=>{if(d){const j=g(o(this.requestHashIds[a],"data"),{hashId:o(_,"hashId")});m(j,0)&&(this.requestHashIds[a].data[j]=_)}c&&p(o(_,"hashId"),o(this.requestHashIds[a],"data.hashId"))&&h(this.requestHashIds[a],"data",_)})})}_pushPayload(s,e){this._isCollectionExisting(s);const t=this._pushToCollection(s,e);return this._pushToAliases(t),this._pushToRequestHashes(t),t}_pushRequestHash(s={},e={isLoading:!0,isError:!1,isNew:!0,data:null}){const t=this._generateHashId(s),r=!b(this.requestHashIds[t]),i=o(e,"isNew");return r&&i?h(this.requestHashIds[t],"isNew",!1):this.requestHashIds[t]=e,this.requestHashIds[t]}setHost(s){this.host=s,this._initializeAxiosConfig()}setNamespace(s){this.namespace=s}setHeadersCommon(s,e){f.defaults.headers.common[`${s}`]=e}setPayloadIncludeReference(s){this.payloadIncludedReference=s}setGlobal(){typeof window<"u"&&(window.ARM=Object.freeze(this))}getCollection(s){return this.collections[s]||[]}clearCollection(s){this.collections[s]=[]}getAlias(s,e){return I(e)&&this._injectActions(e),this.aliases[s]||e}createRecord(s,e={},t=!0){const r=t?N.v1():N.NIL,i=b(y(this.collections[s],{id:r}));return h(e,"id",r),this._injectReferenceKeys(s,e),this._injectActions(e),i&&this.collections[s].push(e),y(this.collections[s],{id:r})}async _request({resourceMethod:s,resourceName:e,resourceId:t,resourceParams:r,resourcePayload:i,resourceFallback:a,resourceConfig:n}){var Z,K,ss;const d={method:s,url:e},c=this._generateHashId({...arguments[0]}),_=p(s,"get"),j=p(s,"delete"),M=p(s,"post"),T=v(t),S=!P(r),B=!P(i),w=o(i,"data")||null;if(T&&h(d,"url",`${e}/${t}`),S&&h(d,"params",r),B){const l={data:C(w,us)};h(d,"data",l)}const G=!b(o(n,"skip")),Q=p(o(n,"skip"),!0),W=this.requestHashIds[c],X=!b(W),Y=o(W,"isNew");if(!(_&&(G&&Q||!G&&X&&!Y||G&&!Q&&X&&!Y))){B&&h(w,"isLoading",!0);try{const l=await f(d),x=((Z=l==null?void 0:l.data)==null?void 0:Z.data)||a,fs=((K=l==null?void 0:l.data)==null?void 0:K.included)||[],Is=((ss=l==null?void 0:l.data)==null?void 0:ss.meta)||{},ps=I(x),_s=q(x);let k=null;return _s&&u(x,H=>this._injectReferenceKeys(e,H)),ps&&this._injectReferenceKeys(e,x),u(fs,H=>{this._injectReferenceKeys(o(H,this.payloadIncludedReference),H),this._pushPayload(o(H,"collectionName"),H)}),k=await this._pushPayload(e,x),n.alias&&this._addAlias(o(n,"alias"),k),M&&this.unloadRecord(w),j&&this.unloadRecord(k),this.requestHashIds[c]={isLoading:!1,isError:!1,isNew:!1,data:k,included:[],meta:Is},Promise.resolve(k)}catch(l){return B&&(h(w,"isError",!0),h(w,"isLoading",!1)),this.requestHashIds[c]={isLoading:!1,isError:!0,isNew:!1,data:l,included:[],meta:{}},Promise.reject(l)}}}query(s,e={},t={}){const r={resourceMethod:"get",resourceName:s,resourceId:null,resourceParams:e,resourcePayload:null,resourceFallback:[],resourceConfig:t},i=V,a=this._pushRequestHash(r,i);return this._request(r),a}queryRecord(s,e={},t={}){const r={resourceMethod:"get",resourceName:s,resourceId:null,resourceParams:e,resourcePayload:null,resourceFallback:{},resourceConfig:t},i=z,a=this._pushRequestHash(r,i);return this._request(r),a}findAll(s,e={}){const t={resourceMethod:"get",resourceName:s,resourceId:null,resourceParams:null,resourcePayload:null,resourceFallback:[],resourceConfig:e},r=V,i=this._pushRequestHash(t,r);return this._request(t),i}findRecord(s,e,t={},r={}){const i={resourceMethod:"get",resourceName:s,resourceId:e,resourceParams:t,resourcePayload:null,resourceFallback:{},resourceConfig:r},a=z,n=this._pushRequestHash(i,a);return this._request(i),n}peekAll(s){return this.collections[s]}peekRecord(s,e){return y(this.collections[s],{id:e})}findBy(s,e={}){return y(s,e)}findIndexBy(s,e={}){return g(s,e)}isEmpty(s){return P(s)}isPresent(s){return!P(s)}isEqual(s,e){return p(s,e)}isNumber(s){return v(s)}isNil(s){return b(s)}isNull(s){return J(s)}isGte(s,e){return m(s,e)}isGt(s,e){return ns(s,e)}isLte(s,e){return hs(s,e)}isLt(s,e){return $(s,e)}}return ls});
