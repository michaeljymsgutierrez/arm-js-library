(function(I,C){typeof exports=="object"&&typeof module<"u"?module.exports=C(require("axios"),require("lodash"),require("mobx"),require("uuid"),require("crypto-js")):typeof define=="function"&&define.amd?define(["axios","lodash","mobx","uuid","crypto-js"],C):(I=typeof globalThis<"u"?globalThis:I||self,I["arm-js-library"]=C(I.axios,I._,I.mobx,I.uuid,I.CryptoJS))})(this,function(I,C,Y,$,Z){"use strict";function K(O){const s=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(O){for(const e in O)if(e!=="default"){const t=Object.getOwnPropertyDescriptor(O,e);Object.defineProperty(s,e,t.get?t:{enumerable:!0,get:()=>O[e]})}}return s.default=O,Object.freeze(s)}const ss=K(Y),{makeObservable:es,observable:x,action:D,toJS:E}=ss,{get:i,set:c,find:b,findIndex:R,isObject:ts,isArray:m,isPlainObject:q,isNumber:B,isNull:is,isNil:F,isEmpty:v,isEqual:_,gte:j,lt:J,flatMap:os,map:U,entries:rs,forEach:f,keysIn:L,omit:w}=C,V={isLoading:!0,isError:!1,isNew:!0,data:[],included:[],meta:{}},G={isLoading:!0,isError:!1,isNew:!0,data:{},included:[],meta:{}},M=["destroyRecord","getCollection","reload","save","set","get","setProperties","isDirty","isError","isLoading","isPristine"],as=["destroyRecord","getCollection","reload","save","set","get","setProperties","isDirty","isError","isLoading","isPristine","hashId","collectionName"];class ns{constructor(s=[]){this.namespace="api/v1",this.host=window.location.origin,this.collections={},this.aliases={},this.requestHashIds={},this.payloadIncludedReference="type",this._initializeCollections(s),this._initializeAxiosConfig(),es(this,{collections:x,aliases:x,requestHashIds:x,_pushPayloadToCollection:D,_pushRequestHash:D,_addCollection:D,_addAlias:D})}_initializeAxiosConfig(){I.defaults.baseURL=this._getBaseURL()}_initializeCollections(s){f(s,e=>this._addCollection(e,[]))}_getBaseURL(){return`${this.host}/${this.namespace}`}_getAuthorizationToken(){return`Token ${window.localStorage.getItem("token")}`}_addCollection(s,e){this.collections[s]=e}_addAlias(s,e){const t=m(e),o=q(e);t&&(this.aliases[s]=e||[]),o&&(this.aliases[s]=e||{})}_generateHashId(s={id:$.v1()}){const e=JSON.stringify(s);return Z.MD5(e).toString()}_getProperty(s){return i(this,s)}_setProperty(s,e){c(this,s,e);const t=w(E(this.originalRecord),M),o=w(E(this),M);_(t,o)?(c(this,"isDirty",!1),c(this,"isPristine",!0)):(c(this,"isDirty",!0),c(this,"isPristine",!1))}_setProperties(s){function e(d,n=""){return os(rs(d),([l,a])=>{const h=n?`${n}.${l}`:l;return ts(a)&&!m(a)&&a!==null?e(a,h):{key:h,value:a}})}const t=e(s);f(t,({key:d,value:n})=>c(this,d,n));const o=w(E(this.originalRecord),M),r=w(E(this),M);_(o,r)?(c(this,"isDirty",!1),c(this,"isPristine",!0)):(c(this,"isDirty",!0),c(this,"isPristine",!1))}unloadRecord(s){const e=L(this.aliases),t=i(s,"collectionName"),o=R(this.collections[t],{hashId:i(s,"hashId")});j(o,0)&&this.collections[t].splice(o,1),f(e,r=>{const d=m(this.aliases[r]),n=q(this.aliases[r]);if(d){const l=R(this.aliases[r],{hashId:i(s,"hashId")});j(l,0)&&this.aliases[r].splice(l,1)}n&&_(i(s,"hashId"),i(this.aliases[r],"hashId"))&&(this.aliases[r]={})})}_saveRecord(s){const e=i(s,"collectionName"),t=b(this.collections[e],{hashId:i(s,"hashId")}),o=B(i(t,"id")),r=o?i(t,"id"):null,a={resourceMethod:o?"put":"post",resourceName:e,resourceId:r,resourceParams:{},resourcePayload:{data:t},resourceFallback:{},resourceConfig:{}};return this._request(a)}async _deleteRecord(s){const e=i(s,"collectionName"),t=b(this.collections[e],{hashId:i(s,"hashId")}),o=i(s,"id"),n={resourceMethod:"delete",resourceName:i(t,"collectionName"),resourceId:o,resourceParams:{},resourcePayload:null,resourceFallback:{},resourceConfig:{}};return this._request(n)}async _reloadRecord(s){const e=i(s,"id"),r={resourceMethod:"get",resourceName:i(s,"collectionName"),resourceId:e,resourceParams:{},resourcePayload:null,resourceFallback:{},resourceConfig:{skip:!1}};return this._request(r)}_getCollectionRecord(s,e={},t){const o=i(e,"referenceKey")||"",r=i(t,o)||[],d=x([]);return f(r,n=>{const l=this._generateHashId({id:i(n,"id"),collectionName:s}),a=b(this.collections[s],{hashId:l});v(a)||d.push(a)}),d}_injectActions(s){const e={get:this._getProperty,set:this._setProperty,setProperties:this._setProperties,save:()=>this._saveRecord(s),destroyRecord:()=>this._deleteRecord(s),reload:()=>this._reloadRecord(s),getCollection:(o,r)=>this._getCollectionRecord(o,r,s)},t=L(e);f(t,o=>{s[o]=e[o]})}_injectReferenceKeys(s,e,t=null){const o=is(t)?this._generateHashId({id:i(e,"id"),collectionName:s}):t;c(e,"collectionName",s),c(e,"hashId",o),c(e,"isLoading",!1),c(e,"isError",!1),c(e,"isPristine",!0),c(e,"isDirty",!1)}_pushPayloadToCollection(s,e){const t=m(e),o=q(e),r=L(this.aliases),d=L(this.requestHashIds);let n=null;if(t){const l=U(e,"hashId");f(e,a=>{const h=R(this.collections[s],{hashId:i(a,"hashId")});this._injectActions(a),J(h,0)&&this.collections[s].push(a),j(h,0)&&(this.collections[s][h]=a)}),n=U(l,a=>b(this.collections[s],{hashId:a})),f(r,a=>{const h=m(this.aliases[a]),g=q(this.aliases[a]);h&&f(n,p=>{const y=R(this.aliases[a],{hashId:i(p,"hashId")});j(y,0)&&(this.aliases[a][y]=p)}),g&&f(n,p=>{_(i(p,"hashId"),i(this.aliases[a],"hashId"))&&(this.aliases[a]=p)})})}if(o){const l=e.hashId,a=R(this.collections[s],{hashId:i(e,"hashId")});this._injectActions(e),J(a,0)&&this.collections[s].push(e),j(a,0)&&(this.collections[s][a]=e),n=b(this.collections[s],{hashId:l}),f(r,h=>{const g=m(this.aliases[h]),p=q(this.aliases[h]);g&&f([n],y=>{const P=R(this.aliases[h],{hashId:i(y,"hashId")});j(P,0)&&(this.aliases[h][P]=y)}),p&&_(i(n,"hashId"),i(this.aliases[h],"hashId"))&&(this.aliases[h]=n)}),f(d,h=>{const g=i(this.requestHashIds[h],"data"),p=m(g),y=q(g);p&&f([n],P=>{const T=R(i(this.requestHashIds[h],"data"),{hashId:i(P,"hashId")});j(T,0)&&(this.requestHashIds[h].data[T]=P)}),y&&_(i(n,"hashId"),i(this.requestHashIds[h],"data.hashId"))&&c(this.requestHashIds[h],"data",n)})}return n}_pushRequestHash(s={},e={isLoading:!0,isError:!1,isNew:!0,data:null}){const t=this._generateHashId(s),o=!F(this.requestHashIds[t]),r=i(e,"isNew");return o&&r?c(this.requestHashIds[t],"isNew",!1):this.requestHashIds[t]=e,this.requestHashIds[t]}setHost(s){this.host=s,this._initializeAxiosConfig()}setNamespace(s){this.namespace=s}setHeadersCommon(s,e){I.defaults.headers.common[`${s}`]=e}setPayloadIncludeReference(s){this.payloadIncludedReference=s}setGlobal(){window&&(window.ARM=Object.freeze(this))}getCollection(s){return this.collections[s]||[]}clearCollection(s){this.collections[s]=[]}getAlias(s,e){return q(e)&&this._injectActions(e),this.aliases[s]||e}createRecord(s,e={}){return c(e,"id",$.v1()),this._injectReferenceKeys(s,e),this._injectActions(e),this.collections[s].push(e),b(this.collections[s],{hashId:i(e,"hashId")})}async _request({resourceMethod:s,resourceName:e,resourceId:t,resourceParams:o,resourcePayload:r,resourceFallback:d,resourceConfig:n}){var Q,W,X;const l={method:s,url:e},a=this._generateHashId({...arguments[0]}),h=i(n,"skip"),g=!F(h),p=_(s,"get"),y=_(s,"delete"),P=_(s,"post"),T=B(t),cs=!v(o),S=!v(r),k=i(r,"data")||null;if(T&&c(l,"url",`${e}/${t}`),cs&&c(l,"params",o),S){const u={data:w(k,as)};c(l,"data",u)}if(p&&!g){const u=this.requestHashIds[a],H=!F(u),z=i(u,"isNew");if(H&&!z)return}if(!(g&&h)){S&&c(k,"isLoading",!0);try{const u=await I(l),H=((Q=u==null?void 0:u.data)==null?void 0:Q.data)||d,z=((W=u==null?void 0:u.data)==null?void 0:W.included)||[],hs=((X=u==null?void 0:u.data)==null?void 0:X.meta)||{},ds=q(H),ls=m(H);let N=null;return ls&&f(H,A=>this._injectReferenceKeys(e,A)),ds&&this._injectReferenceKeys(e,H),f(z,A=>{this._injectReferenceKeys(i(A,this.payloadIncludedReference),A),this._pushPayloadToCollection(i(A,"collectionName"),A)}),N=await this._pushPayloadToCollection(e,H),n.alias&&this._addAlias(i(n,"alias"),N),P&&this.unloadRecord(k),y&&this.unloadRecord(N),this.requestHashIds[a]={isLoading:!1,isError:!1,isNew:!1,data:N,included:[],meta:hs},Promise.resolve(N)}catch(u){return S&&(c(k,"isError",!0),c(k,"isLoading",!1)),this.requestHashIds[a]={isLoading:!1,isError:!0,isNew:!1,data:u,included:[],meta:{}},Promise.reject(u)}}}query(s,e={},t={}){const o={resourceMethod:"get",resourceName:s,resourceId:null,resourceParams:e,resourcePayload:null,resourceFallback:[],resourceConfig:t},r=V,d=this._pushRequestHash(o,r);return this._request(o),d}queryRecord(s,e={},t={}){const o={resourceMethod:"get",resourceName:s,resourceId:null,resourceParams:e,resourcePayload:null,resourceFallback:{},resourceConfig:t},r=G,d=this._pushRequestHash(o,r);return this._request(o),d}findAll(s,e={}){const t={resourceMethod:"get",resourceName:s,resourceId:null,resourceParams:null,resourcePayload:null,resourceFallback:[],resourceConfig:e},o=V,r=this._pushRequestHash(t,o);return this._request(t),r}findRecord(s,e,t={},o={}){const r={resourceMethod:"get",resourceName:s,resourceId:e,resourceParams:t,resourcePayload:null,resourceFallback:{},resourceConfig:o},d=G,n=this._pushRequestHash(r,d);return this._request(r),n}peekAll(s){return this.collections[s]}peekRecord(s,e){return b(this.collections[s],{id:e})}}return ns});
