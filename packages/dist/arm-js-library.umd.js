(function(I,H){typeof exports=="object"&&typeof module<"u"?module.exports=H(require("axios"),require("lodash"),require("mobx"),require("uuid"),require("crypto-js")):typeof define=="function"&&define.amd?define(["axios","lodash","mobx","uuid","crypto-js"],H):(I=typeof globalThis<"u"?globalThis:I||self,I["arm-js-library"]=H(I.axios,I._,I.mobx,I.uuid,I.CryptoJS))})(this,function(I,H,ss,N,es){"use strict";function ts(m){const s=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(m){for(const e in m)if(e!=="default"){const i=Object.getOwnPropertyDescriptor(m,e);Object.defineProperty(s,e,i.get?i:{enumerable:!0,get:()=>m[e]})}}return s.default=m,Object.freeze(s)}const is=ts(ss),{makeObservable:rs,observable:k,action:x,toJS:D}=is,{get:o,set:h,find:q,findIndex:g,isObject:os,isArray:p,isPlainObject:f,isNumber:B,isNull:as,isNil:E,isEmpty:T,isEqual:_,gte:b,lt:J,flatMap:ns,map:U,entries:cs,forEach:u,keysIn:O,omit:P}=H,V={isLoading:!0,isError:!1,isNew:!0,data:[],included:[],meta:{}},v={isLoading:!0,isError:!1,isNew:!0,data:{},included:[],meta:{}},L=["destroyRecord","getCollection","reload","save","set","get","setProperties","isDirty","isError","isLoading","isPristine"],hs=["destroyRecord","getCollection","reload","save","set","get","setProperties","isDirty","isError","isLoading","isPristine","hashId","collectionName"];class ds{constructor(s=[]){this.namespace="api/v1",this.host=typeof window<"u"?window.location.origin:"",this.collections={},this.aliases={},this.requestHashIds={},this.payloadIncludedReference="type",this._initializeCollections(s),this._initializeAxiosConfig(),rs(this,{collections:k,aliases:k,requestHashIds:k,_pushPayload:x,_pushRequestHash:x,_addCollection:x,_addAlias:x})}_initializeAxiosConfig(){I.defaults.baseURL=this._getBaseURL()}_initializeCollections(s){u(s,e=>this._addCollection(e,[]))}_getBaseURL(){return`${this.host}/${this.namespace}`}_getAuthorizationToken(){return`Token ${window.localStorage.getItem("token")}`}_addCollection(s,e){this.collections[s]=e}_addAlias(s,e){const i=p(e),r=f(e);i&&(this.aliases[s]=e||[]),r&&(this.aliases[s]=e||{})}_generateHashId(s={id:N.v1()}){const e=JSON.stringify(s);return es.MD5(e).toString()}_getProperty(s){return o(this,s)}_setProperty(s,e){h(this,s,e);const i=P(D(this.originalRecord),L),r=P(D(this),L);_(i,r)?(h(this,"isDirty",!1),h(this,"isPristine",!0)):(h(this,"isDirty",!0),h(this,"isPristine",!1))}_setProperties(s){function e(a,n=""){return ns(cs(a),([c,d])=>{const y=n?`${n}.${c}`:c;return os(d)&&!p(d)&&d!==null?e(d,y):{key:y,value:d}})}const i=e(s);u(i,({key:a,value:n})=>h(this,a,n));const r=P(D(this.originalRecord),L),t=P(D(this),L);_(r,t)?(h(this,"isDirty",!1),h(this,"isPristine",!0)):(h(this,"isDirty",!0),h(this,"isPristine",!1))}unloadRecord(s){const e=O(this.aliases),i=o(s,"collectionName"),r=g(this.collections[i],{hashId:o(s,"hashId")});b(r,0)&&this.collections[i].splice(r,1),u(e,t=>{const a=p(this.aliases[t]),n=f(this.aliases[t]);if(a){const c=g(this.aliases[t],{hashId:o(s,"hashId")});b(c,0)&&this.aliases[t].splice(c,1)}n&&_(o(s,"hashId"),o(this.aliases[t],"hashId"))&&(this.aliases[t]={})})}_saveRecord(s){const e=o(s,"collectionName"),i=q(this.collections[e],{hashId:o(s,"hashId")}),r=B(o(i,"id")),t=r?o(i,"id"):null,d={resourceMethod:r?"put":"post",resourceName:e,resourceId:t,resourceParams:{},resourcePayload:{data:i},resourceFallback:{},resourceConfig:{}};return this._request(d)}async _deleteRecord(s){const e=o(s,"collectionName"),i=q(this.collections[e],{hashId:o(s,"hashId")}),r=o(s,"id"),n={resourceMethod:"delete",resourceName:o(i,"collectionName"),resourceId:Number(r),resourceParams:{},resourcePayload:null,resourceFallback:{},resourceConfig:{}};return this._request(n)}async _reloadRecord(s){const e=o(s,"id"),t={resourceMethod:"get",resourceName:o(s,"collectionName"),resourceId:Number(e),resourceParams:{},resourcePayload:null,resourceFallback:{},resourceConfig:{skipId:N.v1()}};return this._request(t)}_getCollectionRecord(s,e={},i){const r=o(e,"referenceKey")||"",t=o(e,"async")||!1,a=o(i,r)||[],c=f(a)?[a]:a,d=k([]);return u(c,y=>{const j=this._generateHashId({id:o(y,"id"),collectionName:s}),M=q(this.collections[s],{hashId:j});if(!T(M))d.push(M);else if(t){const F={resourceMethod:"get",resourceName:s,resourceId:o(y,"id"),resourceParams:{},resourcePayload:null,resourceFallback:{},resourceConfig:{}},z=v;this._pushRequestHash(F,z),this._request(F)}}),d}_injectActions(s){const e={get:this._getProperty,set:this._setProperty,setProperties:this._setProperties,save:()=>this._saveRecord(s),destroyRecord:()=>this._deleteRecord(s),reload:()=>this._reloadRecord(s),getCollection:(r,t)=>this._getCollectionRecord(r,t,s)},i=O(e);u(i,r=>{s[r]=e[r]})}_injectReferenceKeys(s,e,i=null){const r=as(i)?this._generateHashId({id:o(e,"id"),collectionName:s}):i;h(e,"collectionName",s),h(e,"hashId",r),h(e,"isLoading",!1),h(e,"isError",!1),h(e,"isPristine",!0),h(e,"isDirty",!1)}_pushToCollection(s,e){const i=p(e),r=f(e);if(i){const t=U(e,"hashId");return u(e,a=>{const n=g(this.collections[s],{hashId:o(a,"hashId")});this._injectActions(a),J(n,0)&&this.collections[s].push(a),b(n,0)&&(this.collections[s][n]=a)}),U(t,a=>q(this.collections[s],{hashId:a}))}if(r){const t=e.hashId,a=g(this.collections[s],{hashId:o(e,"hashId")});return this._injectActions(e),J(a,0)&&this.collections[s].push(e),b(a,0)&&(this.collections[s][a]=e),q(this.collections[s],{hashId:t})}}_pushToAliases(s){const e=p(s),i=f(s),r=O(this.aliases);e&&u(r,t=>{const a=p(this.aliases[t]),n=f(this.aliases[t]);a&&u(s,c=>{const d=g(this.aliases[t],{hashId:o(c,"hashId")});b(d,0)&&(this.aliases[t][d]=c)}),n&&u(s,c=>{_(o(c,"hashId"),o(this.aliases[t],"hashId"))&&(this.aliases[t]=c)})}),i&&u(r,t=>{const a=p(this.aliases[t]),n=f(this.aliases[t]);a&&u([s],c=>{const d=g(this.aliases[t],{hashId:o(c,"hashId")});b(d,0)&&(this.aliases[t][d]=c)}),n&&_(o(s,"hashId"),o(this.aliases[t],"hashId"))&&(this.aliases[t]=s)})}_pushToRequestHashes(s){const e=O(this.requestHashIds),i=p(s);f(s),u(e,r=>{const t=o(this.requestHashIds[r],"data"),a=p(t);f(t),a&&i&&u(s,n=>{const c=g(o(this.requestHashIds[r],"data"),{hashId:o(n,"hashId")});b(c,0)&&(this.requestHashIds[r].data[c]=n)})})}_pushPayload(s,e){p(e);const i=f(e),r=O(this.requestHashIds),t=this._pushToCollection(s,e);return this._pushToAliases(t),i&&u(r,a=>{const n=o(this.requestHashIds[a],"data"),c=p(n),d=f(n);c&&u([t],y=>{const j=g(o(this.requestHashIds[a],"data"),{hashId:o(y,"hashId")});b(j,0)&&(this.requestHashIds[a].data[j]=y)}),d&&_(o(t,"hashId"),o(this.requestHashIds[a],"data.hashId"))&&h(this.requestHashIds[a],"data",t)}),t}_pushRequestHash(s={},e={isLoading:!0,isError:!1,isNew:!0,data:null}){const i=this._generateHashId(s),r=!E(this.requestHashIds[i]),t=o(e,"isNew");return r&&t?h(this.requestHashIds[i],"isNew",!1):this.requestHashIds[i]=e,this.requestHashIds[i]}setHost(s){this.host=s,this._initializeAxiosConfig()}setNamespace(s){this.namespace=s}setHeadersCommon(s,e){I.defaults.headers.common[`${s}`]=e}setPayloadIncludeReference(s){this.payloadIncludedReference=s}setGlobal(){typeof window<"u"&&(window.ARM=Object.freeze(this))}getCollection(s){return this.collections[s]||[]}clearCollection(s){this.collections[s]=[]}getAlias(s,e){return f(e)&&this._injectActions(e),this.aliases[s]||e}createRecord(s,e={},i=!0){const r=i?N.v1():N.NIL,t=E(q(this.collections[s],{id:r}));return h(e,"id",r),this._injectReferenceKeys(s,e),this._injectActions(e),t&&this.collections[s].push(e),q(this.collections[s],{id:r})}async _request({resourceMethod:s,resourceName:e,resourceId:i,resourceParams:r,resourcePayload:t,resourceFallback:a,resourceConfig:n}){var Y,Z,K;const c={method:s,url:e},d=this._generateHashId({...arguments[0]}),y=_(s,"get"),j=_(s,"delete"),M=_(s,"post"),F=B(i),z=!T(r),S=!T(t),A=o(t,"data")||null;if(F&&h(c,"url",`${e}/${i}`),z&&h(c,"params",r),S){const l={data:P(A,hs)};h(c,"data",l)}const $=!E(o(n,"skip")),G=_(o(n,"skip"),!0),Q=this.requestHashIds[d],W=!E(Q),X=o(Q,"isNew");if(!(y&&($&&G||!$&&W&&!X||$&&!G&&W&&!X))){S&&h(A,"isLoading",!0);try{const l=await I(c),C=((Y=l==null?void 0:l.data)==null?void 0:Y.data)||a,us=((Z=l==null?void 0:l.data)==null?void 0:Z.included)||[],ls=((K=l==null?void 0:l.data)==null?void 0:K.meta)||{},fs=f(C),Is=p(C);let w=null;return Is&&u(C,R=>this._injectReferenceKeys(e,R)),fs&&this._injectReferenceKeys(e,C),u(us,R=>{this._injectReferenceKeys(o(R,this.payloadIncludedReference),R),this._pushPayload(o(R,"collectionName"),R)}),w=await this._pushPayload(e,C),n.alias&&this._addAlias(o(n,"alias"),w),M&&this.unloadRecord(A),j&&this.unloadRecord(w),this.requestHashIds[d]={isLoading:!1,isError:!1,isNew:!1,data:w,included:[],meta:ls},Promise.resolve(w)}catch(l){return S&&(h(A,"isError",!0),h(A,"isLoading",!1)),this.requestHashIds[d]={isLoading:!1,isError:!0,isNew:!1,data:l,included:[],meta:{}},Promise.reject(l)}}}query(s,e={},i={}){const r={resourceMethod:"get",resourceName:s,resourceId:null,resourceParams:e,resourcePayload:null,resourceFallback:[],resourceConfig:i},t=V,a=this._pushRequestHash(r,t);return this._request(r),a}queryRecord(s,e={},i={}){const r={resourceMethod:"get",resourceName:s,resourceId:null,resourceParams:e,resourcePayload:null,resourceFallback:{},resourceConfig:i},t=v,a=this._pushRequestHash(r,t);return this._request(r),a}findAll(s,e={}){const i={resourceMethod:"get",resourceName:s,resourceId:null,resourceParams:null,resourcePayload:null,resourceFallback:[],resourceConfig:e},r=V,t=this._pushRequestHash(i,r);return this._request(i),t}findRecord(s,e,i={},r={}){const t={resourceMethod:"get",resourceName:s,resourceId:Number(e),resourceParams:i,resourcePayload:null,resourceFallback:{},resourceConfig:r},a=v,n=this._pushRequestHash(t,a);return this._request(t),n}peekAll(s){return this.collections[s]}peekRecord(s,e){return q(this.collections[s],{id:e})}}return ds});
