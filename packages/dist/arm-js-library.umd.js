(function(I,C){typeof exports=="object"&&typeof module<"u"?module.exports=C(require("axios"),require("lodash"),require("mobx"),require("uuid"),require("crypto-js")):typeof define=="function"&&define.amd?define(["axios","lodash","mobx","uuid","crypto-js"],C):(I=typeof globalThis<"u"?globalThis:I||self,I["arm-js-library"]=C(I.axios,I._,I.mobx,I.uuid,I.CryptoJS))})(this,function(I,C,X,z,Y){"use strict";function Z(H){const s=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(H){for(const e in H)if(e!=="default"){const t=Object.getOwnPropertyDescriptor(H,e);Object.defineProperty(s,e,t.get?t:{enumerable:!0,get:()=>H[e]})}}return s.default=H,Object.freeze(s)}const K=Z(X),{makeObservable:ss,observable:D,action:E,toJS:M}=K,{get:i,set:h,find:q,findIndex:j,isObject:es,isArray:g,isPlainObject:m,isNumber:$,isNull:ts,isNil:F,isEmpty:v,isEqual:_,gte:R,lt:S,flatMap:is,map:B,entries:rs,forEach:u,keysIn:L,omit:w}=C,J={isLoading:!0,isError:!1,isNew:!0,data:[],included:[],meta:{}},U={isLoading:!0,isError:!1,isNew:!0,data:{},included:[],meta:{}},T=["destroyRecord","getCollection","reload","save","set","get","setProperties","isDirty","isError","isLoading","isPristine"],os=["destroyRecord","getCollection","reload","save","set","get","setProperties","isDirty","isError","isLoading","isPristine","hashId","collectionName"];class as{constructor(s=[]){this.namespace="api/v1",this.host=typeof window<"u"?window.location.origin:"",this.collections={},this.aliases={},this.requestHashIds={},this.payloadIncludedReference="type",this._initializeCollections(s),this._initializeAxiosConfig(),ss(this,{collections:D,aliases:D,requestHashIds:D,_pushPayloadToCollection:E,_pushRequestHash:E,_addCollection:E,_addAlias:E})}_initializeAxiosConfig(){I.defaults.baseURL=this._getBaseURL()}_initializeCollections(s){u(s,e=>this._addCollection(e,[]))}_getBaseURL(){return`${this.host}/${this.namespace}`}_getAuthorizationToken(){return`Token ${window.localStorage.getItem("token")}`}_addCollection(s,e){this.collections[s]=e}_addAlias(s,e){const t=g(e),r=m(e);t&&(this.aliases[s]=e||[]),r&&(this.aliases[s]=e||{})}_generateHashId(s={id:z.v1()}){const e=JSON.stringify(s);return Y.MD5(e).toString()}_getProperty(s){return i(this,s)}_setProperty(s,e){h(this,s,e);const t=w(M(this.originalRecord),T),r=w(M(this),T);_(t,r)?(h(this,"isDirty",!1),h(this,"isPristine",!0)):(h(this,"isDirty",!0),h(this,"isPristine",!1))}_setProperties(s){function e(d,a=""){return is(rs(d),([l,n])=>{const c=a?`${a}.${l}`:l;return es(n)&&!g(n)&&n!==null?e(n,c):{key:c,value:n}})}const t=e(s);u(t,({key:d,value:a})=>h(this,d,a));const r=w(M(this.originalRecord),T),o=w(M(this),T);_(r,o)?(h(this,"isDirty",!1),h(this,"isPristine",!0)):(h(this,"isDirty",!0),h(this,"isPristine",!1))}unloadRecord(s){const e=L(this.aliases),t=i(s,"collectionName"),r=j(this.collections[t],{hashId:i(s,"hashId")});R(r,0)&&this.collections[t].splice(r,1),u(e,o=>{const d=g(this.aliases[o]),a=m(this.aliases[o]);if(d){const l=j(this.aliases[o],{hashId:i(s,"hashId")});R(l,0)&&this.aliases[o].splice(l,1)}a&&_(i(s,"hashId"),i(this.aliases[o],"hashId"))&&(this.aliases[o]={})})}_saveRecord(s){const e=i(s,"collectionName"),t=q(this.collections[e],{hashId:i(s,"hashId")}),r=$(i(t,"id")),o=r?i(t,"id"):null,d=e,a=r?"put":"post",l={data:t},n={resourceMethod:a,resourceName:d,resourceId:Number(o),resourceParams:{},resourcePayload:l,resourceFallback:{},resourceConfig:{}};return this._request(n)}async _deleteRecord(s){const e=i(s,"collectionName"),t=q(this.collections[e],{hashId:i(s,"hashId")}),r=i(s,"id"),a={resourceMethod:"delete",resourceName:i(t,"collectionName"),resourceId:Number(r),resourceParams:{},resourcePayload:null,resourceFallback:{},resourceConfig:{}};return this._request(a)}async _reloadRecord(s){const e=i(s,"id"),o={resourceMethod:"get",resourceName:i(s,"collectionName"),resourceId:Number(e),resourceParams:{},resourcePayload:null,resourceFallback:{},resourceConfig:{skip:!1}};return this._request(o)}_getCollectionRecord(s,e={},t){const r=i(e,"referenceKey")||"",o=i(e,"async")||!1,d=i(t,r)||[],a=D([]);return u(d,l=>{const n=this._generateHashId({id:i(l,"id"),collectionName:s}),c=q(this.collections[s],{hashId:n});v(c)?o&&this._request({resourceMethod:"get",resourceName:s,resourceId:i(l,"id"),resourceParams:{},resourcePayload:null,resourceFallback:{},resourceConfig:{skip:!0}}):a.push(c)}),a}_injectActions(s){const e={get:this._getProperty,set:this._setProperty,setProperties:this._setProperties,save:()=>this._saveRecord(s),destroyRecord:()=>this._deleteRecord(s),reload:()=>this._reloadRecord(s),getCollection:(r,o)=>this._getCollectionRecord(r,o,s)},t=L(e);u(t,r=>{s[r]=e[r]})}_injectReferenceKeys(s,e,t=null){const r=ts(t)?this._generateHashId({id:i(e,"id"),collectionName:s}):t;h(e,"collectionName",s),h(e,"hashId",r),h(e,"isLoading",!1),h(e,"isError",!1),h(e,"isPristine",!0),h(e,"isDirty",!1)}_pushPayloadToCollection(s,e){const t=g(e),r=m(e),o=L(this.aliases),d=L(this.requestHashIds);let a=null;if(t){const l=B(e,"hashId");u(e,n=>{const c=j(this.collections[s],{hashId:i(n,"hashId")});this._injectActions(n),S(c,0)&&this.collections[s].push(n),R(c,0)&&(this.collections[s][c]=n)}),a=B(l,n=>q(this.collections[s],{hashId:n})),u(o,n=>{const c=g(this.aliases[n]),b=m(this.aliases[n]);c&&u(a,p=>{const y=j(this.aliases[n],{hashId:i(p,"hashId")});R(y,0)&&(this.aliases[n][y]=p)}),b&&u(a,p=>{_(i(p,"hashId"),i(this.aliases[n],"hashId"))&&(this.aliases[n]=p)})})}if(r){const l=e.hashId,n=j(this.collections[s],{hashId:i(e,"hashId")});this._injectActions(e),S(n,0)&&this.collections[s].push(e),R(n,0)&&(this.collections[s][n]=e),a=q(this.collections[s],{hashId:l}),u(o,c=>{const b=g(this.aliases[c]),p=m(this.aliases[c]);b&&u([a],y=>{const P=j(this.aliases[c],{hashId:i(y,"hashId")});R(P,0)&&(this.aliases[c][P]=y)}),p&&_(i(a,"hashId"),i(this.aliases[c],"hashId"))&&(this.aliases[c]=a)}),u(d,c=>{const b=i(this.requestHashIds[c],"data"),p=g(b),y=m(b);p&&u([a],P=>{const O=j(i(this.requestHashIds[c],"data"),{hashId:i(P,"hashId")});R(O,0)&&(this.requestHashIds[c].data[O]=P)}),y&&_(i(a,"hashId"),i(this.requestHashIds[c],"data.hashId"))&&h(this.requestHashIds[c],"data",a)})}return a}_pushRequestHash(s={},e={isLoading:!0,isError:!1,isNew:!0,data:null}){const t=this._generateHashId(s),r=!F(this.requestHashIds[t]),o=i(e,"isNew");return r&&o?h(this.requestHashIds[t],"isNew",!1):this.requestHashIds[t]=e,this.requestHashIds[t]}setHost(s){this.host=s,this._initializeAxiosConfig()}setNamespace(s){this.namespace=s}setHeadersCommon(s,e){I.defaults.headers.common[`${s}`]=e}setPayloadIncludeReference(s){this.payloadIncludedReference=s}setGlobal(){typeof window<"u"&&(window.ARM=Object.freeze(this))}getCollection(s){return this.collections[s]||[]}clearCollection(s){this.collections[s]=[]}getAlias(s,e){return m(e)&&this._injectActions(e),this.aliases[s]||e}createRecord(s,e={}){return h(e,"id",z.v1()),this._injectReferenceKeys(s,e),this._injectActions(e),this.collections[s].push(e),q(this.collections[s],{hashId:i(e,"hashId")})}async _request({resourceMethod:s,resourceName:e,resourceId:t,resourceParams:r,resourcePayload:o,resourceFallback:d,resourceConfig:a}){var G,Q,W;const l={method:s,url:e},n=this._generateHashId({...arguments[0]}),c=_(s,"get"),b=_(s,"delete"),p=_(s,"post"),y=$(t),P=!v(r),O=!v(o),N=i(o,"data")||null;if(y&&h(l,"url",`${e}/${t}`),P&&h(l,"params",r),O){const f={data:w(N,os)};h(l,"data",f)}const ns=F(i(a,"skip"))?!0:i(a,"skip"),V=this.requestHashIds[n],cs=!F(V),hs=i(V,"isNew");if(!(c&&cs&&!hs&&ns)){O&&h(N,"isLoading",!0);try{const f=await I(l),k=((G=f==null?void 0:f.data)==null?void 0:G.data)||d,ds=((Q=f==null?void 0:f.data)==null?void 0:Q.included)||[],ls=((W=f==null?void 0:f.data)==null?void 0:W.meta)||{},us=m(k),fs=g(k);let x=null;return fs&&u(k,A=>this._injectReferenceKeys(e,A)),us&&this._injectReferenceKeys(e,k),u(ds,A=>{this._injectReferenceKeys(i(A,this.payloadIncludedReference),A),this._pushPayloadToCollection(i(A,"collectionName"),A)}),x=await this._pushPayloadToCollection(e,k),a.alias&&this._addAlias(i(a,"alias"),x),p&&this.unloadRecord(N),b&&this.unloadRecord(x),this.requestHashIds[n]={isLoading:!1,isError:!1,isNew:!1,data:x,included:[],meta:ls},Promise.resolve(x)}catch(f){return O&&(h(N,"isError",!0),h(N,"isLoading",!1)),this.requestHashIds[n]={isLoading:!1,isError:!0,isNew:!1,data:f,included:[],meta:{}},Promise.reject(f)}}}query(s,e={},t={}){const r={resourceMethod:"get",resourceName:s,resourceId:null,resourceParams:e,resourcePayload:null,resourceFallback:[],resourceConfig:t},o=J,d=this._pushRequestHash(r,o);return this._request(r),d}queryRecord(s,e={},t={}){const r={resourceMethod:"get",resourceName:s,resourceId:null,resourceParams:e,resourcePayload:null,resourceFallback:{},resourceConfig:t},o=U,d=this._pushRequestHash(r,o);return this._request(r),d}findAll(s,e={}){const t={resourceMethod:"get",resourceName:s,resourceId:null,resourceParams:null,resourcePayload:null,resourceFallback:[],resourceConfig:e},r=J,o=this._pushRequestHash(t,r);return this._request(t),o}findRecord(s,e,t={},r={}){const o={resourceMethod:"get",resourceName:s,resourceId:Number(e),resourceParams:t,resourcePayload:null,resourceFallback:{},resourceConfig:r},d=U,a=this._pushRequestHash(o,d);return this._request(o),a}peekAll(s){return this.collections[s]}peekRecord(s,e){return q(this.collections[s],{id:e})}}return as});
