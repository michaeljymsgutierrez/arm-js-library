(function(p,C){typeof exports=="object"&&typeof module<"u"?module.exports=C(require("axios"),require("lodash"),require("mobx"),require("uuid"),require("crypto-js")):typeof define=="function"&&define.amd?define(["axios","lodash","mobx","uuid","crypto-js"],C):(p=typeof globalThis<"u"?globalThis:p||self,p["arm-js-library"]=C(p.axios,p._,p.mobx,p.uuid,p.CryptoJS))})(this,function(p,C,ss,T,es){"use strict";function ts(O){const s=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(O){for(const e in O)if(e!=="default"){const i=Object.getOwnPropertyDescriptor(O,e);Object.defineProperty(s,e,i.get?i:{enumerable:!0,get:()=>O[e]})}}return s.default=O,Object.freeze(s)}const is=ts(ss),{makeObservable:rs,observable:D,action:E,toJS:L}=is,{get:t,set:h,find:R,findIndex:j,isObject:os,isArray:q,isPlainObject:g,isNumber:J,isNull:as,isNil:v,isEmpty:z,isEqual:y,gte:P,lt:U,flatMap:ns,map:V,entries:cs,forEach:l,keysIn:M,omit:w}=C,G={isLoading:!0,isError:!1,isNew:!0,data:[],included:[],meta:{}},S={isLoading:!0,isError:!1,isNew:!0,data:{},included:[],meta:{}},F=["destroyRecord","getCollection","reload","save","set","get","setProperties","isDirty","isError","isLoading","isPristine"],hs=["destroyRecord","getCollection","reload","save","set","get","setProperties","isDirty","isError","isLoading","isPristine","hashId","collectionName"];class ds{constructor(s=[]){this.namespace="api/v1",this.host=typeof window<"u"?window.location.origin:"",this.collections={},this.aliases={},this.requestHashIds={},this.payloadIncludedReference="type",this._initializeCollections(s),this._initializeAxiosConfig(),rs(this,{collections:D,aliases:D,requestHashIds:D,_pushPayloadToCollection:E,_pushRequestHash:E,_addCollection:E,_addAlias:E})}_initializeAxiosConfig(){p.defaults.baseURL=this._getBaseURL()}_initializeCollections(s){l(s,e=>this._addCollection(e,[]))}_getBaseURL(){return`${this.host}/${this.namespace}`}_getAuthorizationToken(){return`Token ${window.localStorage.getItem("token")}`}_addCollection(s,e){this.collections[s]=e}_addAlias(s,e){const i=q(e),r=g(e);i&&(this.aliases[s]=e||[]),r&&(this.aliases[s]=e||{})}_generateHashId(s={id:T.v1()}){const e=JSON.stringify(s);return es.MD5(e).toString()}_getProperty(s){return t(this,s)}_setProperty(s,e){h(this,s,e);const i=w(L(this.originalRecord),F),r=w(L(this),F);y(i,r)?(h(this,"isDirty",!1),h(this,"isPristine",!0)):(h(this,"isDirty",!0),h(this,"isPristine",!1))}_setProperties(s){function e(d,n=""){return ns(cs(d),([u,a])=>{const c=n?`${n}.${u}`:u;return os(a)&&!q(a)&&a!==null?e(a,c):{key:c,value:a}})}const i=e(s);l(i,({key:d,value:n})=>h(this,d,n));const r=w(L(this.originalRecord),F),o=w(L(this),F);y(r,o)?(h(this,"isDirty",!1),h(this,"isPristine",!0)):(h(this,"isDirty",!0),h(this,"isPristine",!1))}unloadRecord(s){const e=M(this.aliases),i=t(s,"collectionName"),r=j(this.collections[i],{hashId:t(s,"hashId")});P(r,0)&&this.collections[i].splice(r,1),l(e,o=>{const d=q(this.aliases[o]),n=g(this.aliases[o]);if(d){const u=j(this.aliases[o],{hashId:t(s,"hashId")});P(u,0)&&this.aliases[o].splice(u,1)}n&&y(t(s,"hashId"),t(this.aliases[o],"hashId"))&&(this.aliases[o]={})})}_saveRecord(s){const e=t(s,"collectionName"),i=R(this.collections[e],{hashId:t(s,"hashId")}),r=J(t(i,"id")),o=r?t(i,"id"):null,d=e,n=r?"put":"post",u={data:i},a={resourceMethod:n,resourceName:d,resourceId:Number(o),resourceParams:{},resourcePayload:u,resourceFallback:{},resourceConfig:{}};return this._request(a)}async _deleteRecord(s){const e=t(s,"collectionName"),i=R(this.collections[e],{hashId:t(s,"hashId")}),r=t(s,"id"),n={resourceMethod:"delete",resourceName:t(i,"collectionName"),resourceId:Number(r),resourceParams:{},resourcePayload:null,resourceFallback:{},resourceConfig:{}};return this._request(n)}async _reloadRecord(s){const e=t(s,"id"),o={resourceMethod:"get",resourceName:t(s,"collectionName"),resourceId:Number(e),resourceParams:{},resourcePayload:null,resourceFallback:{},resourceConfig:{skipTimestamp:T.v1()}};return this._request(o)}_getCollectionRecord(s,e={},i){const r=t(e,"referenceKey")||"",o=t(e,"async")||!1,d=t(i,r)||[],u=g(d)?[d]:d,a=D([]);return l(u,c=>{const m=this._generateHashId({id:t(c,"id"),collectionName:s}),f=R(this.collections[s],{hashId:m});if(!z(f))a.push(f);else if(o){const _={resourceMethod:"get",resourceName:s,resourceId:t(c,"id"),resourceParams:{},resourcePayload:null,resourceFallback:{},resourceConfig:{}},b=S;this._pushRequestHash(_,b),this._request(_)}}),a}_injectActions(s){const e={get:this._getProperty,set:this._setProperty,setProperties:this._setProperties,save:()=>this._saveRecord(s),destroyRecord:()=>this._deleteRecord(s),reload:()=>this._reloadRecord(s),getCollection:(r,o)=>this._getCollectionRecord(r,o,s)},i=M(e);l(i,r=>{s[r]=e[r]})}_injectReferenceKeys(s,e,i=null){const r=as(i)?this._generateHashId({id:t(e,"id"),collectionName:s}):i;h(e,"collectionName",s),h(e,"hashId",r),h(e,"isLoading",!1),h(e,"isError",!1),h(e,"isPristine",!0),h(e,"isDirty",!1)}_pushPayloadToCollection(s,e){const i=q(e),r=g(e),o=M(this.aliases),d=M(this.requestHashIds);let n=null;if(i){const u=V(e,"hashId");l(e,a=>{const c=j(this.collections[s],{hashId:t(a,"hashId")});this._injectActions(a),U(c,0)&&this.collections[s].push(a),P(c,0)&&(this.collections[s][c]=a)}),n=V(u,a=>R(this.collections[s],{hashId:a})),l(o,a=>{const c=q(this.aliases[a]),m=g(this.aliases[a]);c&&l(n,f=>{const _=j(this.aliases[a],{hashId:t(f,"hashId")});P(_,0)&&(this.aliases[a][_]=f)}),m&&l(n,f=>{y(t(f,"hashId"),t(this.aliases[a],"hashId"))&&(this.aliases[a]=f)})})}if(r){const u=e.hashId,a=j(this.collections[s],{hashId:t(e,"hashId")});this._injectActions(e),U(a,0)&&this.collections[s].push(e),P(a,0)&&(this.collections[s][a]=e),n=R(this.collections[s],{hashId:u}),l(o,c=>{const m=q(this.aliases[c]),f=g(this.aliases[c]);m&&l([n],_=>{const b=j(this.aliases[c],{hashId:t(_,"hashId")});P(b,0)&&(this.aliases[c][b]=_)}),f&&y(t(n,"hashId"),t(this.aliases[c],"hashId"))&&(this.aliases[c]=n)}),l(d,c=>{const m=t(this.requestHashIds[c],"data"),f=q(m),_=g(m);f&&l([n],b=>{const H=j(t(this.requestHashIds[c],"data"),{hashId:t(b,"hashId")});P(H,0)&&(this.requestHashIds[c].data[H]=b)}),_&&y(t(n,"hashId"),t(this.requestHashIds[c],"data.hashId"))&&h(this.requestHashIds[c],"data",n)})}return n}_pushRequestHash(s={},e={isLoading:!0,isError:!1,isNew:!0,data:null}){const i=this._generateHashId(s),r=!v(this.requestHashIds[i]),o=t(e,"isNew");return r&&o?h(this.requestHashIds[i],"isNew",!1):this.requestHashIds[i]=e,this.requestHashIds[i]}setHost(s){this.host=s,this._initializeAxiosConfig()}setNamespace(s){this.namespace=s}setHeadersCommon(s,e){p.defaults.headers.common[`${s}`]=e}setPayloadIncludeReference(s){this.payloadIncludedReference=s}setGlobal(){typeof window<"u"&&(window.ARM=Object.freeze(this))}getCollection(s){return this.collections[s]||[]}clearCollection(s){this.collections[s]=[]}getAlias(s,e){return g(e)&&this._injectActions(e),this.aliases[s]||e}createRecord(s,e={}){return h(e,"id",T.v1()),this._injectReferenceKeys(s,e),this._injectActions(e),this.collections[s].push(e),R(this.collections[s],{hashId:t(e,"hashId")})}async _request({resourceMethod:s,resourceName:e,resourceId:i,resourceParams:r,resourcePayload:o,resourceFallback:d,resourceConfig:n}){var Y,Z,K;const u={method:s,url:e},a=this._generateHashId({...arguments[0]}),c=y(s,"get"),m=y(s,"delete"),f=y(s,"post"),_=J(i),b=!z(r),H=!z(o),N=t(o,"data")||null;if(_&&h(u,"url",`${e}/${i}`),b&&h(u,"params",r),H){const I={data:w(N,hs)};h(u,"data",I)}const $=!v(t(n,"skip")),Q=y(t(n,"skip"),!0),B=this.requestHashIds[a],W=!v(B),X=t(B,"isNew");if(y(t(B,"isLoading"),!0),!(c&&($&&Q||!$&&W&&!X||$&&!Q&&W&&!X))){H&&h(N,"isLoading",!0);try{const I=await p(u),k=((Y=I==null?void 0:I.data)==null?void 0:Y.data)||d,us=((Z=I==null?void 0:I.data)==null?void 0:Z.included)||[],ls=((K=I==null?void 0:I.data)==null?void 0:K.meta)||{},fs=g(k),Is=q(k);let x=null;return Is&&l(k,A=>this._injectReferenceKeys(e,A)),fs&&this._injectReferenceKeys(e,k),l(us,A=>{this._injectReferenceKeys(t(A,this.payloadIncludedReference),A),this._pushPayloadToCollection(t(A,"collectionName"),A)}),x=await this._pushPayloadToCollection(e,k),n.alias&&this._addAlias(t(n,"alias"),x),f&&this.unloadRecord(N),m&&this.unloadRecord(x),this.requestHashIds[a]={isLoading:!1,isError:!1,isNew:!1,data:x,included:[],meta:ls},Promise.resolve(x)}catch(I){return H&&(h(N,"isError",!0),h(N,"isLoading",!1)),this.requestHashIds[a]={isLoading:!1,isError:!0,isNew:!1,data:I,included:[],meta:{}},Promise.reject(I)}}}query(s,e={},i={}){const r={resourceMethod:"get",resourceName:s,resourceId:null,resourceParams:e,resourcePayload:null,resourceFallback:[],resourceConfig:i},o=G,d=this._pushRequestHash(r,o);return this._request(r),d}queryRecord(s,e={},i={}){const r={resourceMethod:"get",resourceName:s,resourceId:null,resourceParams:e,resourcePayload:null,resourceFallback:{},resourceConfig:i},o=S,d=this._pushRequestHash(r,o);return this._request(r),d}findAll(s,e={}){const i={resourceMethod:"get",resourceName:s,resourceId:null,resourceParams:null,resourcePayload:null,resourceFallback:[],resourceConfig:e},r=G,o=this._pushRequestHash(i,r);return this._request(i),o}findRecord(s,e,i={},r={}){const o={resourceMethod:"get",resourceName:s,resourceId:Number(e),resourceParams:i,resourcePayload:null,resourceFallback:{},resourceConfig:r},d=S,n=this._pushRequestHash(o,d);return this._request(o),n}peekAll(s){return this.collections[s]}peekRecord(s,e){return R(this.collections[s],{id:e})}}return ds});
